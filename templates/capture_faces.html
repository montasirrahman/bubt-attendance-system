{% extends "base.html" %} {% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h4 class="card-title mb-0">
          <i class="fas fa-camera me-2"></i>Face Capture
        </h4>
      </div>
      <div class="card-body text-center">
        {% if session.get('registering_student') %}
        <div class="alert alert-info">
          <h5>
            <i class="fas fa-user me-2"></i>
            Registering: {{ session['registering_student']['name'] }} ({{
            session['registering_student']['student_id'] }})
          </h5>
        </div>
        {% endif %}

        <!-- Status Message -->
        <div id="statusMessage" class="alert alert-warning">
          <i class="fas fa-info-circle me-2"></i>
          <span id="statusText">Ready to start face capture</span>
        </div>

        <!-- Face Count Display -->
        <div class="mb-3">
          <h5 id="faceCount" class="text-success">Faces Captured: 0/50</h5>
        </div>

        <p class="text-muted mb-4">
          Please position your face in the camera view. The system will
          automatically capture 50 images. Ensure good lighting and look
          directly at the camera.
        </p>

        <div class="mb-4">
          <img
            id="videoFeed"
            src=""
            class="img-fluid rounded"
            style="max-width: 640px; border: 3px solid #198754; display: none"
            alt="Video Feed"
          />
        </div>

        <!-- Control Buttons -->
        <div class="mb-4">
          <button id="startBtn" class="btn btn-primary btn-lg me-3">
            <i class="fas fa-play me-2"></i>Start Capture
          </button>
          <button id="saveBtn" class="btn btn-success btn-lg" disabled>
            <i class="fas fa-save me-2"></i>Save Faces & Complete Registration
          </button>
        </div>

        <div class="mt-4">
          <a
            href="{{ url_for('register_page') }}"
            class="btn btn-secondary btn-lg"
            id="cancelBtn"
          >
            <i class="fas fa-times me-2"></i>Cancel & Return to Registration
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  $(document).ready(function () {
    let statusInterval;

    function updateStatus() {
      $.get("/check_capture_status")
        .done(function (data) {
          console.log("Status:", data);
          updateUI(data);
        })
        .fail(function (error) {
          console.error("Error checking status:", error);
          $("#statusText").text("Error checking status");
        });
    }

    function updateUI(data) {
      const statusElement = $("#statusMessage");
      const statusText = $("#statusText");
      const faceCountElement = $("#faceCount");
      const startBtn = $("#startBtn");
      const saveBtn = $("#saveBtn");
      const videoFeed = $("#videoFeed");

      // Update face count
      faceCountElement.text(`Faces Captured: ${data.face_count}/50`);

      if (data.in_progress) {
        statusElement
          .removeClass("alert-warning alert-success alert-danger")
          .addClass("alert-warning");
        statusText.html(
          '<i class="fas fa-sync-alt fa-spin me-2"></i>Capturing faces... Please look at the camera.'
        );
        startBtn.prop("disabled", true);
        saveBtn.prop("disabled", true);
        videoFeed.show();
      } else if (data.complete) {
        statusElement
          .removeClass("alert-warning alert-danger")
          .addClass("alert-success");
        statusText.html(
          `<i class="fas fa-check-circle me-2"></i>Capture complete! ${data.face_count} faces captured.`
        );
        startBtn.prop("disabled", true);
        saveBtn.prop("disabled", false);

        if (data.face_count < 20) {
          statusElement.removeClass("alert-success").addClass("alert-danger");
          statusText.html(
            `<i class="fas fa-exclamation-triangle me-2"></i>Warning: Only ${data.face_count} faces captured (minimum 20 required)`
          );
          saveBtn.prop("disabled", true);
        }
      } else {
        statusElement
          .removeClass("alert-success alert-danger")
          .addClass("alert-warning");
        statusText.html(
          '<i class="fas fa-info-circle me-2"></i>Ready to start face capture'
        );
        startBtn.prop("disabled", false);
        saveBtn.prop("disabled", true);
        videoFeed.hide();
      }
    }

    // Start Capture
    $("#startBtn").on("click", function () {
      console.log("Starting face capture...");

      $.get("/start_capture")
        .done(function (data) {
          if (data.success) {
            console.log("Capture started successfully");
            // Start video feed with cache busting
            $("#videoFeed")
              .attr("src", "/video_feed?t=" + new Date().getTime())
              .show();
            // Start status updates every second
            statusInterval = setInterval(updateStatus, 1000);
            updateStatus(); // Immediate update
          } else {
            alert("Error: " + data.message);
          }
        })
        .fail(function (error) {
          console.error("Error starting capture:", error);
          alert(
            "Error starting capture: " + error.responseJSON?.message ||
              error.statusText
          );
        });
    });

    // Save Faces
    $("#saveBtn").on("click", function () {
      console.log("Saving faces to database...");
      const saveBtn = $(this);
      const statusText = $("#statusText");

      saveBtn.prop("disabled", true);
      statusText.html(
        '<i class="fas fa-sync-alt fa-spin me-2"></i>Saving faces to database...'
      );

      $.ajax({
        url: "/save_captured_faces",
        method: "POST",
        contentType: "application/json",
        success: function (data) {
          if (data.success) {
            statusText.html(
              `<i class="fas fa-check-circle me-2"></i>${data.message}`
            );
            alert("Registration successful! " + data.message);
            setTimeout(() => {
              window.location.href = "/register";
            }, 2000);
          } else {
            statusText.html(
              `<i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.message}`
            );
            saveBtn.prop("disabled", false);
            alert("Error: " + data.message);
          }
        },
        error: function (error) {
          console.error("Error saving faces:", error);
          statusText.html(
            `<i class="fas fa-exclamation-triangle me-2"></i>Error saving faces: ${
              error.responseJSON?.message || error.statusText
            }`
          );
          saveBtn.prop("disabled", false);
          alert(
            "Error saving faces: " + error.responseJSON?.message ||
              error.statusText
          );
        },
      });
    });

    // Cancel button
    $("#cancelBtn").on("click", function () {
      if (statusInterval) {
        clearInterval(statusInterval);
      }
    });

    // Initialize status check every 3 seconds
    setInterval(updateStatus, 3000);
    updateStatus(); // Initial update
  });
</script>
{% endblock %}
